#!/bin/bash
# Check that occurrence objects are unique
# cat $ECOTAXA_TSV | nd-csv | nd-map --select object_id | nd-count -d # should yield nothing

if [[ ! -f $ECOTAXA_TSV ]]
then
  echo "Downloading EcoTaxa TSV from $ECOTAXA_TSV_URL"
  mkdir -p `dirname $ECOTAXA_TSV`
  curl $ECOTAXA_TSV_URL > $ECOTAXA_TSV
fi

# Occurrences
echo "Creating Darwin Core occurrences NDJSON from $ECOTAXA_URL TSV in $DWC_NDJSON"
mkdir -p $DWC_NDJSON

cat "$ECOTAXA_TSV" \
  | sed 's/living>other>egg/living>Eukaryota>Animalia>egg/' \
  | nd-csv -sn \
  | grep -v "not-living>" \
  | grep -v "living>other>" \
  | nd-map 'd.sample_id = d.sample_id.replace(/_(narrow|large)$/, ""), d' \
  | ecotaxa-occurrences --from json --country NO --project "$ECOTAXA_PROJECT" \
      --dataset-id "$DATASET_ID" --dataset-name "$DATASET_NAME" \
      --temporary "$ECOTAXA_TEMPORARY_MAP" \
  | nd-map 'd.canonicalName = d.scientificName,d' \
  > $DWC_OCCURRENCES_NDJSON 2> $DWC_NDJSON/error.log > $DWC_OCCURRENCES_NDJSON

# Events
if [[ ! -f $DWC_EVENTS_NDJSON ]]
then
  echo "Creating Darwin Core events NDJSON from $ECOTAXA_URL TSV in $DWC_NDJSON"
  EVENT_FIELDS=`cat config/event-fields.txt`
  cat $DWC_OCCURRENCES_NDJSON \
    | nd-count --key occurrences --select "$EVENT_FIELDS" \
    | nd-group d.eventID | nd-map d[1][0] \
    > $DWC_EVENTS_NDJSON
else
  echo "$DWC_EVENTS_NDJSON exists, not extracting events from occurrences"
fi


# Ignored and rejected
head -n1 $ECOTAXA_TSV > $DWC_NDJSON/ignored.tsv
cat $ECOTAXA_TSV | grep "not-living>" >> $DWC_NDJSON/ignored.tsv
cat $ECOTAXA_TSV | sed 's/living>other>egg/living>Eukaryota>Animalia>egg/' | grep "living>other>" >> $DWC_NDJSON/ignored.tsv

cat $DWC_NDJSON/ignored.tsv | nd-csv | nd-count --select object_annotation_hierarchy > $DWC_NDJSON/ignored-objects.ndjson
rm $DWC_NDJSON/ignored.tsv
